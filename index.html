<!DOCTYPE html>
<html>

<head>

    <title>WebGL Model Viewer</title>

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <link href="https://fonts.googleapis.com/css?family=Titillium+Web" rel="stylesheet">
    <link rel="shortcut icon" href="favicon.ico">

    <link rel='stylesheet' href='css/spectrum.css' />

    <script src="js/three.js"></script>
    <script src="js/CanvasRenderer.js"></script>
    <script src="js/Projector.js"></script>
    <script src="js/MTLLoader.js"></script>
    <script src="js/OBJLoader.js"></script>
    <script src="js/DDSLoader.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/THREEx.FullScreen.js"></script>
    <script src="js/jquery.nicescroll.js"></script>
    <script src="js/spectrum.js"></script>
    
    <script src="frameworks/loaders/ColladaLoader.js"></script>
    <script src="frameworks/loaders/collada/Animation.js"></script>
    <script src="frameworks/loaders/collada/AnimationHandler.js"></script>
    <script src="frameworks/loaders/collada/KeyFrameAnimation.js"></script>

    <script>
    $(document).ready(function () {
        $("html").niceScroll({ styler: "fb", cursorcolor: "#000"});
        $("#stats").niceScroll();
    });
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  
    <link rel='stylesheet' href='css/main_style.css' />

    <script>
        $(function () {
            $("#red, #green, #blue, #ambient_red, #ambient_green, #ambient_blue").slider({
                orientation: "horizontal",
                range: "min",
                max: 255,
                value: 127  //Default value, Light colour of model set to median value (grey colour)
            });                   
        });
    </script>

    <script id="vertexShader" type="x-shader/x-vertex">
        uniform float p;
        varying float intensity;
        void main()
        {
            vec3 vNormal = normalize( normalMatrix * normal );
            intensity = pow(1.0 - abs(dot(vNormal, vec3(0, 0, 1))), p);
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
    </script>

    <script id="fragmentShader" type="x-shader/x-vertex">
        uniform vec3 glowColor;
        varying float intensity;
        void main()
        {
            vec3 glow = glowColor * intensity;
            gl_FragColor = vec4( glow, 1.0 );
        }
    </script>
</head>

<body>

    <div id="container">
        <div id="stats"></div>

        <!--Side Menu Start-->
        <div class="side_menu">

            <ul class="menu_item">

                <li id="header">
                    <table style="width:100%">
                        <tr>
                            <th style="font-size: 15px;">Viewer Options</th>
                            <th style="font-size: 11px;"><button id="lightSkin">Light</button></th>
                            <th style="font-size: 11px;"><button id="darkSkin">Dark</button></th>
                        </tr>                        
                    </table>
                </li>

                <li class='dropdown'>
                    <a href='#'><img src="images/ambient_icon.png" class="image" />Ambient Light</a>
                    <ul>
                        <li><span>Ambient Light ON/OFF</span></li>
                        <li>
                            <label class="switch">
                                <input type="checkbox" id="ambient_light">
                                <span class="toggle round"></span>
                            </label>
                        </li>
                        <li><span style="font-size: 12px">R</span></li>
                        <li><div id="ambient_red"></div></li>
                        <li><span style="font-size: 12px">G</span></li>
                        <li><div id="ambient_green"></div></li>
                        <li><span style="font-size: 12px">B</span></li>
                        <li><div id="ambient_blue"></div></li>
                    </ul>
                </li>


                <li class='dropdown'>
                    <a href='#' id="dir_click"><img src="images/dir_light_icon.png" class="image" />Directional Light Colour</a>
                    <ul>
                        <li><span style="font-size: 12px">R</span></li>
                        <li><div id="red"></div></li>
                        <li><span style="font-size: 12px">G</span></li>
                        <li><div id="green"></div></li>
                        <li><span style="font-size: 12px">B</span></li>
                        <li><div id="blue"></div></li>
                    </ul>
                </li>

                <li class='dropdown'>
                    <a href='#'><img src="images/wireframe_cube.png" class="image" />Wireframe View</a>
                    <ul>
                        <li><span>Wireframe ON/OFF</span></li>
                        <li>
                            <label class="switch">
                                <input type="checkbox" id="wire_check">
                                <span class="toggle round"></span>
                            </label>
                        </li>
                        <li><span>Model + Wireframe ON/OFF</span></li>
                        <li>
                            <label class="switch">
                                <input type="checkbox" id="model_wire">
                                <span class="toggle round"></span>
                            </label>
                        </li>
                    </ul>
                </li>

                <li class='dropdown'>
                    <a href='#'><img src="images/phong_icon.png" class="image" />Phong Shading</a>
                    <ul>
                        <li> <span>Phong Shading ON/OFF </span></li>
                        <li>
                            <label class="switch">
                                <input type="checkbox" id="phong_check">
                                <span class="toggle round"></span>
                            </label>
                        </li>
                        <li><span style="font-size: 12px">Shininess</span></li>
                        <li><div id="shine"></div></li>
                    </ul>
                </li>

               <!--<li class='dropdown'>
                    <a href='#'><img src="images/phong_icon.png" class="image" />Viewport Test</a>
                    <ul>                     
                        <li>
                            <table>
                                <tr><td>
                                        <div class="checkboxContainer">
                                            <input type="checkbox" class="custom_image" value="1" id="CB1" title="my title"><label for='CB1'>&nbsp;&nbsp; Wireframe View</label>
                                            <div class="infoCheckbox">
                                                <p>Info on checkbox 1</p>
                                            </div>
                                         </div>
                                </td></tr>
                                <tr><td>                                   
                                        <div class="checkboxContainer">
                                            <input type="checkbox" class="custom_image" value="2" id="CB2" /><label for='CB2'>&nbsp;</label>
                                            <div class="infoCheckbox">
                                                <p>Info on checkbox 2</p>
                                            </div>
                                        </div>                                    
                                 </td></tr>
                                <tr><td><input type="checkbox" class="custom_image" value="3" id="CB3" /><label for='CB3'>&nbsp;</label></td></tr>
                                <tr><td><input type="checkbox" class="custom_image" value="4" id="CB4" /><label for='CB4'>&nbsp;</label></td></tr>
                            </table>
                        </li>
                    </ul>
                </li>--> 

               
                <li class='dropdown'>
                    <a href='#'><img src="images/XRay.png" class="image" />X-Ray Shading</a>
                    <ul>
                        <li> <span>X-Ray ON/OFF </span></li>
                        <li>
                            <label class="switch">
                                <input type="checkbox" id="xray_check">
                                <span class="toggle round"></span>
                            </label>
                        </li>
                    </ul>
                </li>

                <li class='dropdown'>
                    <a href='#'><img src="images/glow_icon.png" width="32" height="32" class="image" />Glow Shader</a>
                    <ul>
                        <li> <span>Glow On/Off</span></li>
                        <li>
                            <label class="switch">
                                <input type="checkbox" id="glow_check">
                                <span class="toggle round"></span>
                            </label>
                        </li>
                        <li> <span>Set Glow Colour</span></li>
                        <li><input type='text' class="glow_select" /></li>
                        <li><em id='basic-log'></em></li>
                    </ul>
                </li>

                <li class='dropdown'>
                    <a href='#'><img src="images/colour_pick.png" class="image" />Set Background</a>
                    <ul>
                        <li> <span>Set Background Colour</span></li>
                        <li><input type='text' class="bg_select" /></li>                         
                        <li><em id='basic_log'></em></li>
                        <li>Set Background Image</li>
                        <li><input type="file" id="bg_tex" accept="image/*" /></li> 
                        <li><button type="button" id="remove_bg">Remove Background</button></li>
                    </ul>
                </li>

                <li class='dropdown'>
                    <a href='#'><img src="images/folder_icon.png" class="image" />Select .obj File</a>
                    <ul>
                        <li>.obj File</li>
                        <li ><input type="file" id="obj_file" /></li>
                        <li>.mtl File</li>
                        <li><input type="file" id="mtl_file" /></li>
                        <li>Remove File</li>
                        <li><button type="button" id="remove">Remove file</button></li>
                        <li>Image Files</li>
                        <li><input type="file" id="images" multiple="multiple" accept="image/*" /></li>
                        <output id="result" />
                    </ul>
                </li>             
            </ul> 
            <button id="Rotate_X">Rotate X</button>
            <div id="disp_tmp_path"></div>               
        </div> 
        <!--Side Menu End-->

        <!--Bottom Menu Start-->
        <div id="bottom_menu">
           <ul class="bottom_menu_item">
                <li class='dropdown'>
                    <a href='#'><img src="images/rotation.png" class="image" />Model Rotation</a>
                    <ul>
                        <li style ="display:inline-block;  margin:0 35px 0 0;"><span>Apply Rotation ON/OFF </span></li>
                        <li style="display:inline-block"><span>Set Rotation Speed</span>
                            <span id="rot_slider"></span>
                        </li>
                        <li>
                            <label class="switch">
                                <input type="checkbox" id="rotation">
                                <span class="toggle round"></span>
                            </label>                                                                            
                        </li>         
                    </ul>
                </li>

               <li class='dropdown'>
                   <a href='#'><img src="images/scale.png" class="image" />Scale Model</a>
                   <ul>
                       <li style="text-align:center; font-size: 15px">
                           <span>Scale Up:</span> &nbsp;<button id="scale_up" style="margin:0 35px 0 0" type="button">+</button>
                           <span>Scale Down:</span> &nbsp;<button id="scale_down" type="button">-</button>
                       </li>
                   </ul>
               </li>

               <li class='dropdown'>
                   <a href='#'><img src="images/grid.png" class="image" />Model View Helpers</a>
                   <ul style="font-size: 13.5px">
                       <li style="display:inline-block; margin:0 25px 0 0;">
                           <span>Grid On/Off</span>
                           <label class="switch">
                               <input type="checkbox" id="grid">
                               <span class="toggle round"></span>
                           </label>
                       </li>
                       <li style="display:inline-block; margin:0 25px 0 0;">
                           <span>Polar Grid On/Off</span>
                           <label class="switch">
                               <input type="checkbox" id="polar_grid">
                               <span class="toggle round"></span>
                           </label>
                       </li>
                       <li style="display:inline-block; margin:0 25px 0 0;">
                           <span>Axis On/Off</span>
                           <label class="switch">
                               <input type="checkbox" id="axis">
                               <span class="toggle round"></span>
                           </label>
                       </li>
                       <li style="display:inline-block; margin:0 25px 0 0;">
                           <span>Model Box On/Off</span>
                           <label class="switch">
                               <input type="checkbox" id="bBox">
                               <span class="toggle round"></span>
                           </label>
                       </li>
                   </ul>
               </li>
             </ul>
           </div>
        <!--Bottom Menu End-->

        <div id="main_viewer"></div>

        <div id="fullscreen">
            <button id="fullscreenBtn" title="Fullscreen Mode" style="border: 0; float:right; background: transparent">
                <img src="images/fullscreen.png" width="32" height="32" alt="fullscreen" />
            </button>
        </div>

        <script>
            $(document).ready(function () {

                $(".menu_item > li > a").on("click", function (e) {

                    if (!$(this).hasClass("active")) {

                        // hide any open menus and remove all other classes
                        $(".menu_item li ul").slideUp(350);
                        $(".menu_item li a").removeClass("active");

                        // open new menu and add the open class
                        $(this).next("ul").slideDown(350);
                        $(this).addClass("active");

                    } else if ($(this).hasClass("active")) {

                        $(this).removeClass("active");
                        $(this).next("ul").slideUp(350);
                    }
                });

                $(".bottom_menu_item > li > a").on("click", function (e) {

                    if (!$(this).hasClass("active")) {

                        // hide any open menus and remove all other classes
                        $(".bottom_menu_item li ul").slideUp(350);
                        $(".bottom_menu_item li a").removeClass("active");

                        // open new menu and add the open class
                        $(this).next("ul").slideDown(350);
                        $(this).addClass("active");

                    } else if ($(this).hasClass("active")) {

                        $(this).removeClass("active");
                        $(this).next("ul").slideUp(350);
                    }
                });

                $(".checkboxContainer").hover(
                    function () {
                        $(this).find(".infoCheckbox:first").show();
                    },
                    function () {
                        $(this).find(".infoCheckbox:first").hide();
                    }
                );              
            });
        </script>
      
        <script>
            var view = document.getElementById('main_viewer');

            var camera, camerHelper, scene, renderer, stats, controls, model, glowModel,
                delta, raycaster, mouse, phongMaterial;

            var modelLoaded = false;
            var bg_Texture = false;

            var glowMaterial, glow_value;
 
            var ambient, directionalLight, directionalLight2, directionalLight3, bg_colour;
            var backgroundScene, backgroundCamera, backgroundMesh;

            var scale = 1;
            var amb = document.getElementById('ambient_light');
            var rot1 = document.getElementById('rotation');
            var wire = document.getElementById('wire_check');
            var model_wire = document.getElementById('model_wire');
            var phong = document.getElementById('phong_check');
            var xray = document.getElementById('xray_check');
            var glow = document.getElementById('glow_check');
            var grid = document.getElementById('grid');
            var polar_grid = document.getElementById('polar_grid');
            var axis = document.getElementById('axis');
            var bBox = document.getElementById('bBox');

            var statsNode = document.getElementById('stats');

            var clock = new THREE.Clock();

            var objects = [];

            var winDims = [window.innerWidth * 0.8, window.innerHeight * 0.89];

            var winHalfW = winDims[0] / 2;

            function init() {
                scene = new THREE.Scene();

                camera = new THREE.PerspectiveCamera(70, winDims[0] / winDims[1], .1, 500000);
                camera.position.set(0, 0, 20);
                //camera.lookAt(new THREE.Vector3());
                scene.add(camera);

                /*cameraHelper = new THREE.CameraHelper(camera);
                scene.add(cameraHelper);*/

                //Setup renderer     
                //renderer = new THREE.CanvasRenderer();
                renderer = new THREE.WebGLRenderer({ alpha: true });
                renderer.setSize(winDims[0], winDims[1]);
                renderer.setClearColor(0x292121); //565646, 292121

                view.appendChild(renderer.domElement);

                function toggleFullscreen(elem) {
                    elem = elem || document.documentElement;
                    if (!document.fullscreenElement && !document.mozFullScreenElement &&
                        !document.webkitFullscreenElement && !document.msFullscreenElement)
                    {
                        THREEx.FullScreen.request(container);
                        renderer.setSize(screen.width, screen.height); //Fullscreen renderer (for chrome)
                        view.style.marginLeft = "261px"; //Move div containing WebGL renderer to the right
                                                        //in fullscreen mode, so that the object appears in 
                                                       //same location and not shifted to the left.
                                                      //ONLY WORKING IN CHROME FOR NOW
 
                       // controls.reset();
                        //camera.updateProjectionMatrix();
                    }
                    else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.msExitFullscreen) {
                            document.msExitFullscreen();
                            renderer.setSize(winDims[0], winDims[1]); //Reset renderer size on fullscreen exit
                        } else if (document.mozCancelFullScreen) {
                            document.mozCancelFullScreen();
                            renderer.setSize(winDims[0], winDims[1]);
                        } else if (document.webkitExitFullscreen) {
                            document.webkitExitFullscreen();
                            renderer.setSize(winDims[0], winDims[1]);
                        }
                    }
                }
                document.getElementById('fullscreenBtn').addEventListener('click', function () {
                    toggleFullscreen();
                }); 

                ambient = new THREE.AmbientLight(0x404040);

                $('#ambient_light').change(function () {
                    if (amb.checked) {
                        scene.add(ambient);
                    }
                    else {
                        scene.remove(ambient);
                    }
                });

                directionalLight = new THREE.DirectionalLight(0xffeedd);
                directionalLight.position.set(0, 0, 1).normalize();
                scene.add(directionalLight);

                directionalLight2 = new THREE.DirectionalLight(0xffeedd);
                directionalLight2.position.set(0, 0, -1).normalize();
                scene.add(directionalLight2);

                var ambientLight = new THREE.AmbientLight(0x808080, 0.2); //Grey colour, low intensity
                scene.add(ambientLight);

               /* var groundGeometry = new THREE.BoxGeometry(30, 0.01, 40);
                var groundMaterial = new THREE.MeshLambertMaterial({ color: 'rgb(0,130,0)' });
                groundMesh = new THREE.Mesh(groundGeometry, groundMaterial);
                groundMesh.position.y = 0.0;
                scene.add(groundMesh);*/

                controls = new THREE.OrbitControls(camera, renderer.domElement);
                /*controls.maxPolarAngle = Math.PI * 0.5;*/
                // controls.minDistance = 0.5;
                //controls.maxDistance = 1180;

                //Colour changer, to set background colour of renderer to user chosen colour
                $(".bg_select").spectrum({
                    color: "#fff",
                    change: function (color) {
                        $("#basic_log").text("Hex Colour Selected: " + color.toHexString()); //Log information
                         var bg_value = $(".bg_select").spectrum('get').toHexString(); //Get the colour selected
                         renderer.setClearColor(bg_value); //Set renderer colour to the selected hex value
                         document.body.style.background = bg_value; //Set body of document to selected colour              
                    }
                });
  
                //Function for loading image as renderer (static) background
                $('#bg_tex').change(function () {
                    var file = this.files[0];
                    var reader = new FileReader();
                    reader.onloadend = function ()
                    {
                        renderer.setClearColor(0x000000, 0);
                        bg_Texture = true; //Only run background scene, when background texture is loaded

                        // Load the background texture
                        var loader = new THREE.TextureLoader();
                        var texture = loader.load(reader.result);

                        //Plane mesh to hold background texture from image file
                        backgroundMesh = new THREE.Mesh(
                            new THREE.PlaneGeometry(2, 2, 0),
                            new THREE.MeshBasicMaterial({
                                map: texture
                            }));

                        backgroundMesh.material.depthTest = false;
                        backgroundMesh.material.depthWrite = false;

                        //Create background scene
                        backgroundScene = new THREE.Scene();
                        backgroundCamera = new THREE.Camera();
                        backgroundScene.add(backgroundCamera);
                        backgroundScene.add(backgroundMesh);

                    }
                    if (file) {
                        reader.readAsDataURL(file);
                    } else {
                    }
                });

                $('#remove_bg').click(function () {
                    backgroundScene.remove(backgroundMesh); //remove background mesh containing the image
                });

                /*loadDAE("model/", "avatar.dae", scene, function (obj) {
                    monster = obj;
                    render();
                });*/
                
                document.getElementById('obj_file').addEventListener('change', readFile, false); //Read .obj file

                document.getElementById('mtl_file').addEventListener('change', readMTL, false);

                /***MATERIALS***/

                //Default Material
                var default_material = new THREE.MeshLambertMaterial({ side: THREE.DoubleSide });

                //var default_material = new THREE.MeshNormalMaterial();

                var wireframeMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFFFF, wireframe: true, transparent: true });

                phongMaterial = new THREE.MeshPhongMaterial({
                    color: 0x555555,
                    specular: 0xffffff, shininess: 10,
                    shading: THREE.SmoothShading,
                    side: THREE.DoubleSide
                }); //Phong for reflectivity 

                //jQuery slider for phong shininess level
                $("#shine").slider({
                    orientation: "horizontal",
                    min: 10,
                    max: 500,
                    value: 10,
                    slide: function (event, ui) {
                        phongMaterial.shininess = ui.value; //Set speed variable to the current selected value of slider
                    }
                });

                $("#shine").slider({
                    change: function (event, ui)
                    {
                        console.log(ui.value);
                        phongMaterial.shininess = ui.value; //Set shininess of phong material to value from the slider
                    }
                 });

                /***********CHANGE ABOVE AS INITIAL BASIC MATERIAL FOR LOADED MODEL***********/

                /***********CAN ALSO USE IT FOR MULTIPLE MATERIAL OPTIONS E.G. PHONG SHADING AND SMOOTH SHADING***********/


                //X-RAY SHADER MATERIAL
                //http://free-tutorials.org/shader-x-ray-effect-with-three-js/
                var $$ = document.querySelector.bind(document);

                xrayMaterial = new THREE.ShaderMaterial({
                    uniforms: {
                        p: { type: "f", value: 3 },
                        glowColor: { type: "c", value: new THREE.Color(0x84ccff) },
                    },
                    vertexShader: $$('#vertexShader').text,
                    fragmentShader: $$('#fragmentShader').text,
                    side: THREE.DoubleSide,
                    blending: THREE.AdditiveBlending,
                    transparent: true,
                    depthWrite: false
                    //wireframe: true //wireframe could be added, to view x-ray and wireframe combined view
                });

                //GLOW SHADER MATERIAL
                glowMaterial = new THREE.ShaderMaterial({
                    uniforms: {
                        p: { type: "f", value: 0.1 },
                        glowColor: { type: "c", value: new THREE.Color(0xffff80) },
                    },
                    vertexShader: document.getElementById('vertexShader').textContent,
                    fragmentShader: document.getElementById('fragmentShader').textContent,
                    side: THREE.BackSide,
                    blending: THREE.AdditiveBlending,
                    transparent: true
                });

                $(".glow_select").spectrum({
                    color: "#fff",
                    change: function (color) {
                        $("#basic-log").text("Hex Colour Selected: " + color.toHexString()); //Log information
                        glow_value = $(".glow_select").spectrum('get').toHexString(); //Get the colour selected
                        //Set glow material colour to selected value
                        glowMaterial.uniforms.glowColor.type = "c";
                        glowMaterial.uniforms.glowColor.value = new THREE.Color(glow_value);
                    }
                });


                //TESTING IMAGE UPLOADING, FOR POSSIBLE USE WITH MODEL .MTL FILE
                var filesInput = document.getElementById("images");
                var i;

                filesInput.addEventListener("change", function (event) {

                    var files = event.target.files; //FileList object
                    var output = document.getElementById("result");

                    for (i = 0; i < files.length; i++) {
                        var file = files[i];

                        //Only pics
                        if (!file.type.match('image'))
                            continue;


                        console.group("File " + i);
                        console.log("name : " + file.name);
                        console.log("size : " + file.size);
                        console.log("type : " + file.type);
                        console.log("date : " + file.lastModified);
                        console.groupEnd();

                        /* var names = $.map(files, function (val) { return val.name; });

                            alert(names);*/


                        /* var picReader = new FileReader();

                            picReader.addEventListener("load", function (event) {

                                var picFile = event.target;

                                var div = document.createElement("div");

                                div.innerHTML = "<img class='thumbnail' src='" + picFile.result + "'" +
                                        "title='" + picFile.name + "'/>";

                                output.insertBefore(div, null);

                            });*/

                        //Read the image
                        //picReader.readAsDataURL(file);
                    }
                });

                function readMTL(event) {

                    var file = event.target.files[0];
                    var mtl_reader = new FileReader();

                    mtl_reader.onload = function () {

                        //var mtlLoader = new THREE.MTLLoader();
                        //var materials = mtlLoader.parse(this.result);

                        var mtl_loader = new THREE.MTLLoader();

                        materials = mtl_loader.parse(this.result);

                        //alert(this.result);

                        var tmppath = URL.createObjectURL(event.target.files[0]);
                        $("#disp_tmp_path").html("Temporary Path --> <strong>[" + tmppath + "]</strong>");

                    };
                    mtl_reader.readAsText(file);
                }

                var fileType = ['obj'];
                var reader;

                function readFile(evt)
                {
                    if (evt.target.files && evt.target.files[0])
                    {
                        var extension = evt.target.files[0].name.split('.').pop().toLowerCase(), //get .obj file extension from input file
                            isSuccess = fileType.indexOf(extension) > -1;  //is extension acceptable type

                        if (isSuccess)
                        {
                            modelLoaded = true;
                            var fileObject = evt.target.files[0];
                            reader = new FileReader();

                            var tmppath = URL.createObjectURL(evt.target.files[0]); //Testing a temporary path for .obj file

                            reader.onload = function (e)
                            {
                                //var mtlLoader = new THREE.MTLLoader();
                                //var materials = mtlLoader.parse(this.result);
                                document.getElementById("scale_up").disabled = false;
                                document.getElementById("scale_down").disabled = false;

                                var loader = new THREE.OBJLoader();
                                
                                //alert(this.result);
                                loader.setPath(tmppath)
                                console.log(tmppath);

                                model = loader.parse(this.result); //Set model to be the user file
                                $("#disp_tmp_path").html("Temporary Path --> <strong>[" + tmppath + "]</strong>"); //Display temp path

                                var geometry;
                                model.traverse(function (child) {
                                    if (child instanceof THREE.Mesh) {
                                        geometry = new THREE.Geometry().fromBufferGeometry(child.geometry);

                                        if (geometry !== undefined)
                                        {
                                           // console.log(geometry.vertices.length);
                                            // var position = new THREE.Vector3();
                                            // position.getPositionFromMatrix(model.matrixWorld);
                                            // alert(position.x + ',' + position.y + ',' + position.z);

                                            //Dislay file name, number of vertices and faces info of model
                                            statsNode.innerHTML = 'Name of model/file: ' + fileObject.name
                                                + '<br>'
                                                + 'Number of vertices: ' + geometry.vertices.length
                                                + '<br>'
                                                + 'Number of faces: ' + geometry.faces.length;
                                            // + '<br>'
                                            //+ 'Model Position: ' + position.x + ',' + position.y + ',' + position.z;
                                        }
                                        
                                        child.material = default_material;

                                        var geo = new THREE.EdgesGeometry(child.geometry); // or WireframeGeometry
                                        var mat = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 2 });
                                        var wireframe = new THREE.LineSegments(geo, mat);

                                        $('#wire_check').change(function () {
                                            if (wire.checked) {
                                                child.material = wireframeMaterial;
                                                model_wire.checked = false;
                                            }
                                            else if (phong.checked) {
                                                child.material = phongMaterial;
                                                //if phong shading is on when selecting wireframe, go back to phong, when wireframe is off
                                            }
                                            else {
                                                child.material = default_material;
                                            }
                                        });

                                        $('#model_wire').change(function () {
                                            if (model_wire.checked) {
                                                    wire.checked = false;
                                                    child.material = default_material;
                                                    child.add(wireframe);                                                                                          
                                            }                                          
                                            else {
                                                child.material = default_material;
                                                child.remove(wireframe);
                                            }
                                        });

                                        $('#phong_check').change(function () {
                                            if (phong.checked) {
                                                child.material = phongMaterial;
                                            }
                                            else {
                                                child.material = default_material;
                                            }
                                        });

                                        $('#xray_check').change(function () {
                                            if (xray.checked) {
                                                child.material = xrayMaterial;
                                            }
                                            else {
                                                child.material = default_material;
                                            }
                                        });

                                        glowModel = new THREE.Mesh(geometry, glowMaterial);
                                        glowMaterial.visible = false;
                                        glowModel.position = model.position;
                                        glowModel.scale.multiplyScalar(1.025);
                                        model.add(glowModel);

                                        $('#glow_check').change(function () {
                                            if (glow.checked) {
                                                glowMaterial.visible = true;
                                            }
                                            else {
                                                glowMaterial.visible = false;
                                                scene.remove(glowModel);
                                                child.material = default_material;
                                            }
                                        });

                                    }
                                });

                                model.position.set(0, 0, 0);

                                bound_box = new THREE.BoxHelper(model); //, 0xffffff
                                bound_box.visible = false;
                                model.add(bound_box); //Add bounding box helper to model (when checkbox is checked)

                                var bbox = new THREE.Box3();
                                bbox.setFromObject(model);
                                console.log(bbox.min.y);
                               
                                
                               //Bounding Sphere with radius set based on non visible model box
                               /* var geometry2 = new THREE.SphereGeometry(bbox.max.z * 3, 32, 16);
                                var material = new THREE.MeshLambertMaterial({ wireframe: true, color: 0x000088 });
                                mesh = new THREE.Mesh(geometry2, material);
                                mesh.position.x = (bbox.max.x + bbox.min.x) / 2; //Set sphere to be at centre of model
                                mesh.position.y = (bbox.max.y + bbox.min.y) / 2;
                                mesh.position.z = (bbox.max.z + bbox.min.z) / 2;
                                model.add(mesh);*/
                                
                                /*POLAR GRID HELPER*/
                                var radius = 10;
                                var radials = 16;
                                var circles = 8;
                                var divisions = 64;

                                polar_grid_helper = new THREE.PolarGridHelper(bbox.max.x * 4, radials, circles, divisions);
                                polar_grid_helper.position.y = bbox.min.y;
                                polar_grid_helper.visible = false;
                                model.add(polar_grid_helper);
 
                                /*NORMAL GRID HELPER*/
                                gridHelper = new THREE.GridHelper(bbox.max.x * 4, 40, 0xe6e600, 0x808080);
                                //Set size of grid to cover objects of all sizes based on the non visible box3() size.
                               // gridHelper.position.x = 0;
                                gridHelper.position.y = bbox.min.y; //Set grid underneath loaded model object
                               // gridHelper.position.z = 0;
                                gridHelper.visible = false; //Grid visibility initially false, until grid checkbox is selected
                                model.add(gridHelper);

                                /*AXIS HELPER*/
                                axis_view = new THREE.AxisHelper(bbox.max.z * 10); //Set axis size based on the non visible box3() size.
                                axis_view.position.y = bbox.min.y; //Set axis underneath loaded model object
                                axis_view.visible = false; //axis visibility initially false, until axis checkbox is selected
                                model.add(axis_view);

                                console.log(renderer.info.memory.geometries);

                                $("#Rotate_X").click(function () {

                                    model.rotation.x = -Math.PI / 2;
                                    polar_grid_helper.rotation.x = Math.PI / 2;
                                    gridHelper.rotation.x = Math.PI / 2;
                                    axis_view.rotation.x = Math.PI / 2;
                                });

                                scene.add(model);
                                objects.push(model);
                            };
                            reader.readAsText(fileObject);
                        }
                        else { //File other than .obj type selected
                            alert("Wrong file type, please select .obj files only");
                        }

                        var size = document.getElementById('obj_file').files[0].size;

                        //progress/loading bar
                        reader.onprogress = function (data) { 
                            if (data.lengthComputable) { //if size of file transfer is known
                                var percentage = Math.round((data.loaded * 100) / data.total);
                                console.log(percentage);
                                statsNode.innerHTML = 'Loaded : ' + percentage + '%' + ' of ' + fileObject.name
                                + '<progress value="0" max="100" class="progress"></progress>';
                                // + 'Size of file ' + Math.round(size / 1048576) + 'Mbs';
                                $('.progress').css({ 'width': percentage + '%' });////Width of progress bar set to the current percentage of model loaded (progress bar therefore increases in width as model loads)
                                $('.progress').val(percentage); //Set progress bar value to the current amount loaded
                            }
                        }
                    }
                }


                function loadDAE(path, fileOBJ, scene, fSuc) {
                    var loader = new THREE.ColladaLoader();
                    var onProgress = function (xhr) { };
                    var onError = function (xhr) { if (fFail) { fFail(xhr); } };
                    loader.load(path + fileOBJ, function (collada) {
                        var object = collada.scene;
                        //SCALE NEEDS TO BE CONSIDERED
                        object.scale.x = object.scale.y = object.scale.z = 1.5; //Correct scale
                        object.rotateY(-Math.PI / 2); //Core orientation
                        object.rotateX(-Math.PI / 2); //Rotate the horizontal orientation                     
                        object.updateMatrix();
                        object.position.set(0, 0, 0);

                        //Active shadows
                        object.traverse(function (child) {
                            if (child instanceof THREE.Mesh) {
                                child.castShadow = true;
                            }
                            if (child instanceof THREE.SkinnedMesh) {
                                var animation = new THREE.Animation(child, child.geometry.animation);
                                animation.play();
                            }

                        });
                        object.castShadow = true;

                        scene.add(object);
                        fSuc(object);

                    }, onProgress, onError);
                };

                function scaleUp()
                {
                   if(modelLoaded)
                    {
                        scale = scale + (scale * 0.55);
                        model.scale.x = model.scale.y = model.scale.z = scale;
                        camera.lookAt(model.position);
                        controls.reset();
                    }
                }
                function scaleDown()
                {
                    if (modelLoaded)
                    {
                        scale = scale - (scale * 0.25);
                        model.scale.x = model.scale.y = model.scale.z = scale;
                        camera.lookAt(model.position);
                        controls.reset();
                    }
                }
                $('#scale_up').click(function (e)
                {
                    scaleUp();
                });
  
                $('#scale_down').click(function (e)
                {
                    scaleDown();
                });
                
                function removeModel() {
                    scene.remove(model);
                    scene.remove(glowModel); //Remove glow model if present
                    glowMaterial.visible = false;
                    camera.position.set(0, 0, 20); //Reset camera to initial position
                    controls.reset(); //Reset controls, for when previous object has been moved around e.g. larger object = larger rotation
                    statsNode.innerHTML = ''; //Reset stats box (faces, vertices etc)
                    $("#red, #green, #blue, #ambient_red, #ambient_green, #ambient_blue").slider("value", 127); //Reset colour sliders
                    amb.checked = false; rot1.checked = false; wire.checked = false;
                    model_wire.checked = false; phong.checked = false; xray.checked = false;
                    glow.checked = false; grid.checked = false; polar_grid.checked = false;
                    axis.checked = false; bBox.checked = false;//Uncheck any checked boxes
                   
                    $('#rot_slider').slider({
                        disabled: true //disable the rotation slider
                    });
                    controls.autoRotate = false; //Stop model auto rotating if doing so on new file select
                    $('#shine').slider("value", 10); //Set phong shine level back to initial
                }

                var fileSelect = document.getElementById('obj_file');                          
                fileSelect.onchange = function ()
                {
                    if (fileSelect.value.length == 0)
                    { //if user selects cancel from file opener dialog, keep current model in scene                      
                        console.log('Cancelled file selection');
                    } else {
                        //When selecting a file, if a model is already present, remove current model before loading new model  
                        removeModel();
                    }
                }

                $('#remove').click(function () {
                    removeModel();
                });


                $("#red, #green, #blue, #ambient_red, #ambient_green, #ambient_blue").slider({
                    change: function (event, ui) {
                        console.log(ui.value);
                        render();
                    }
                });

                var rotVal = [230, 400, 600, 750, 960, 1200, 1500, 1800, 1900, 2100, 2350]; //Rotation speeds low - high
                var rotation_speed;

                $("#rot_slider").slider({
                    orientation: "horizontal",
                    range: "min",
                    max: rotVal.length - 1,
                    value: 0,
                    disabled: true,
                    slide: function (event, ui) {
                        rotation_speed = rotVal[ui.value]; //Set speed variable to the current selected value of slider
                    }
                });

                $('#rotation').change(function () {
                    if (rot1.checked) {
                        rotation_speed = rotVal[$("#rot_slider").slider("value")];
                        //set the speed to the current slider value on initial use
                        controls.autoRotate = true;

                        $("#rot_slider").slider({
                            disabled: false,
                            change: function (event, ui) {
                                console.log(rotVal[ui.value]);
                                controls.autoRotate = true;
                                controls.autoRotateSpeed = delta * rotation_speed;
                            }
                        });
                    }
                    else {
                        controls.autoRotate = false;
                        $('#rot_slider').slider({
                            disabled: true //disable the slider from being able to rotate object when rotation toggle is off
                        });
                    }
                });

                //document.addEventListener('mousedown', onDocumentMouseDown, false);

                //FURTHER IDEAS - BACKGROUND COLOUR/TEXTURE PICKER
                //              - AXIS HELPER, GRID DISPLAY
                //              - PLACE OBJECTS USING GEOMETRIES AND RAYCASTER
                //              - GLOW EFFECT ON MODEL
                //              - LOAD .DAE FILES AS WELL AS .OBJ FILES (WITH ANY ANIMATIONS)

            }

            function setColours() {
                var colour = getColours($('#red').slider("value"), $('#green').slider("value"), $('#blue').slider("value"));
                directionalLight.color.setRGB(colour[0], colour[1], colour[2]);
                directionalLight2.color.setRGB(colour[0], colour[1], colour[2]);

                var colour = getColours($('#ambient_red').slider("value"), $('#ambient_green').slider("value"),
                                        $('#ambient_blue').slider("value"));
                ambient.color.setRGB(colour[0], colour[1], colour[2]);

            }

            function getColours(r, g, b) {
                var colour = [r.valueOf() / 255, g.valueOf() / 255, b.valueOf() / 255];
                return colour;
            }
  
            function render() {
                setColours();
                //animations
                THREE.AnimationHandler.update(delta);

                if (bg_Texture)
                {
                    renderer.autoClear = false;
                    renderer.clear();
                    renderer.render(backgroundScene, backgroundCamera);
                }

                renderer.render(scene, camera);
            }

            function animate() {
                delta = clock.getDelta();
                requestAnimationFrame(animate);
                controls.update(delta);     
                render();
            }

            init();
            animate();
        </script>
    </div>
    
    <script src="js/initialModel.js"></script>
    <script src="js/ColourTheme.js"></script>

   </body>

</html>
